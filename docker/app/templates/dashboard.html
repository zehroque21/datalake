<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLake - Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Custom CSS para design moderno */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chart-container {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }
        
        .status-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .status-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .status-running {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .btn-modern {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        .table-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="gradient-bg min-h-screen">
    <div x-data="dashboard()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="glass border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i data-lucide="database" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">DataLake</h1>
                            <p class="text-white/70 text-sm">Dashboard de Monitoramento</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-white/80">
                            <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
                            <span class="text-sm">Sistema Online</span>
                        </div>
                        
                        <button @click="refreshData()" 
                                class="btn-modern text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4" :class="{'animate-spin': loading}"></i>
                            <span>Atualizar</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Jobs Hoje -->
                <div class="metric-card rounded-2xl p-6 fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Jobs Hoje</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1" x-text="metrics.jobs_today || '0'"></p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="play-circle" class="w-6 h-6 text-blue-600"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <div class="flex items-center text-green-600 text-sm">
                            <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                            <span x-text="metrics.success_rate || '0'">0</span>% sucesso
                        </div>
                    </div>
                </div>

                <!-- Jobs Bem-sucedidos -->
                <div class="metric-card rounded-2xl p-6 fade-in" style="animation-delay: 0.1s">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Sucessos</p>
                            <p class="text-3xl font-bold text-green-600 mt-1" x-text="metrics.successful_jobs || '0'"></p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-gray-500 text-sm">Última execução</div>
                        <div class="text-sm font-medium" x-text="formatTime(metrics.last_execution?.timestamp)">-</div>
                    </div>
                </div>

                <!-- Jobs com Falha -->
                <div class="metric-card rounded-2xl p-6 fade-in" style="animation-delay: 0.2s">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Falhas</p>
                            <p class="text-3xl font-bold text-red-600 mt-1" x-text="metrics.failed_jobs || '0'"></p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-gray-500 text-sm">Taxa de falha</div>
                        <div class="text-sm font-medium" x-text="(100 - (metrics.success_rate || 0)).toFixed(1) + '%'">0%</div>
                    </div>
                </div>

                <!-- Total de Jobs -->
                <div class="metric-card rounded-2xl p-6 fade-in" style="animation-delay: 0.3s">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">Total</p>
                            <p class="text-3xl font-bold text-purple-600 mt-1" x-text="metrics.total_jobs || '0'"></p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i data-lucide="activity" class="w-6 h-6 text-purple-600"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button @click="triggerJob('weather_collection')" 
                                class="btn-modern text-white px-3 py-1 rounded-lg text-sm flex items-center space-x-1">
                            <i data-lucide="play" class="w-3 h-3"></i>
                            <span>Executar Job</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Temperature Chart -->
                <div class="chart-container fade-in" style="animation-delay: 0.4s">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">Temperatura - Campinas</h3>
                        <div class="flex items-center space-x-2 text-gray-500">
                            <i data-lucide="thermometer" class="w-5 h-5"></i>
                            <span class="text-sm">Últimas 24h</span>
                        </div>
                    </div>
                    <div class="relative h-64">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>

                <!-- Humidity Chart -->
                <div class="chart-container fade-in" style="animation-delay: 0.5s">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">Umidade</h3>
                        <div class="flex items-center space-x-2 text-gray-500">
                            <i data-lucide="droplets" class="w-5 h-5"></i>
                            <span class="text-sm">Últimas 24h</span>
                        </div>
                    </div>
                    <div class="relative h-64">
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="table-modern fade-in" style="animation-delay: 0.6s">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Execuções Recentes</h3>
                        <div class="flex items-center space-x-2 text-gray-500">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            <span class="text-sm">Últimas 20 execuções</span>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duração</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registros</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="job in jobs" :key="job.id">
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <i data-lucide="zap" class="w-4 h-4 text-blue-500 mr-2"></i>
                                            <span class="text-sm font-medium text-gray-900" x-text="job.job_name"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-800': job.status === 'success',
                                                  'bg-red-100 text-red-800': job.status === 'error',
                                                  'bg-yellow-100 text-yellow-800': job.status === 'running'
                                              }"
                                              x-text="job.status === 'success' ? 'Sucesso' : job.status === 'error' ? 'Erro' : 'Executando'">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span x-text="job.duration_seconds ? job.duration_seconds.toFixed(3) + 's' : '-'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span x-text="job.records_processed || '0'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="formatTime(job.start_time)"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        function dashboard() {
            return {
                metrics: {},
                weatherData: [],
                jobs: [],
                loading: false,
                temperatureChart: null,
                humidityChart: null,

                async init() {
                    await this.loadData();
                    this.initCharts();
                    this.startAutoRefresh();
                    
                    // Initialize Lucide icons
                    lucide.createIcons();
                },

                async loadData() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.loadMetrics(),
                            this.loadWeatherData(),
                            this.loadJobs()
                        ]);
                    } catch (error) {
                        console.error('Erro ao carregar dados:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadMetrics() {
                    try {
                        const response = await fetch('/api/metrics');
                        this.metrics = await response.json();
                    } catch (error) {
                        console.error('Erro ao carregar métricas:', error);
                        this.metrics = {
                            jobs_today: 0,
                            successful_jobs: 0,
                            failed_jobs: 0,
                            total_jobs: 0,
                            success_rate: 0,
                            last_execution: null
                        };
                    }
                },

                async loadWeatherData() {
                    try {
                        const response = await fetch('/api/weather');
                        this.weatherData = await response.json();
                        this.updateCharts();
                    } catch (error) {
                        console.error('Erro ao carregar dados meteorológicos:', error);
                        this.weatherData = [];
                    }
                },

                async loadJobs() {
                    try {
                        const response = await fetch('/api/jobs');
                        const data = await response.json();
                        this.jobs = data.executions || [];
                    } catch (error) {
                        console.error('Erro ao carregar jobs:', error);
                        this.jobs = [];
                    }
                },

                initCharts() {
                    // Temperature Chart
                    const tempCtx = document.getElementById('temperatureChart').getContext('2d');
                    this.temperatureChart = new Chart(tempCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Temperatura (°C)',
                                data: [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '°C';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });

                    // Humidity Chart
                    const humCtx = document.getElementById('humidityChart').getContext('2d');
                    this.humidityChart = new Chart(humCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Umidade (%)',
                                data: [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: 'rgb(16, 185, 129)',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                },

                updateCharts() {
                    if (!this.temperatureChart || !this.humidityChart) return;

                    const labels = this.weatherData.map(item => 
                        new Date(item.timestamp).toLocaleTimeString('pt-BR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })
                    ).reverse();

                    const temperatures = this.weatherData.map(item => item.temperature).reverse();
                    const humidity = this.weatherData.map(item => item.humidity).reverse();

                    // Update temperature chart
                    this.temperatureChart.data.labels = labels;
                    this.temperatureChart.data.datasets[0].data = temperatures;
                    this.temperatureChart.update('none');

                    // Update humidity chart
                    this.humidityChart.data.labels = labels;
                    this.humidityChart.data.datasets[0].data = humidity;
                    this.humidityChart.update('none');
                },

                async triggerJob(jobName) {
                    try {
                        const response = await fetch(`/api/jobs/trigger/${jobName}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            // Aguardar um pouco e recarregar dados
                            setTimeout(() => {
                                this.loadData();
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Erro ao executar job:', error);
                    }
                },

                async refreshData() {
                    await this.loadData();
                },

                startAutoRefresh() {
                    setInterval(() => {
                        this.loadData();
                    }, 30000); // Atualizar a cada 30 segundos
                },

                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    return new Date(timestamp).toLocaleString('pt-BR');
                }
            }
        }
    </script>
</body>
</html>

