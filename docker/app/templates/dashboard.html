<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLake - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-active {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid #60a5fa;
        }
        .job-card {
            transition: all 0.3s ease;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .status-success { 
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .status-error { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .status-running { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .dag-node {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin: 8px;
            transition: all 0.3s ease;
        }
        .dag-node:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .dag-success { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .dag-error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .dag-running { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-800">
    <div x-data="dashboard()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="glassmorphism border-b border-white/20">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-white/20 rounded-lg">
                            <i data-lucide="database" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">DataLake</h1>
                            <p class="text-blue-100 text-sm">Dashboard de Monitoramento</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 text-green-300">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm font-medium">Sistema Online</span>
                        </div>
                        <button @click="refreshData()" class="glassmorphism px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-200 flex items-center space-x-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>Atualizar</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="glassmorphism rounded-xl p-1 mb-6 inline-flex">
                <button @click="activeTab = 'analytics'" 
                        :class="activeTab === 'analytics' ? 'tab-active' : ''"
                        class="px-6 py-3 rounded-lg text-white font-medium transition-all duration-200 flex items-center space-x-2">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>Analytics</span>
                </button>
                <button @click="activeTab = 'jobs'" 
                        :class="activeTab === 'jobs' ? 'tab-active' : ''"
                        class="px-6 py-3 rounded-lg text-white font-medium transition-all duration-200 flex items-center space-x-2">
                    <i data-lucide="play-circle" class="w-4 h-4"></i>
                    <span>Jobs</span>
                </button>
            </div>

            <!-- Analytics Tab -->
            <div x-show="activeTab === 'analytics'" x-transition class="space-y-6">
                <!-- Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Jobs Hoje -->
                    <div class="glassmorphism rounded-xl p-6 hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Jobs Hoje</p>
                                <p class="text-3xl font-bold text-white mt-2" x-text="metrics.jobs_today">0</p>
                                <p class="text-green-300 text-sm mt-1">
                                    <i data-lucide="trending-up" class="w-3 h-3 inline mr-1"></i>
                                    <span x-text="metrics.success_rate + '% sucesso'">100% sucesso</span>
                                </p>
                            </div>
                            <div class="p-3 bg-blue-500/20 rounded-lg">
                                <i data-lucide="calendar" class="w-6 h-6 text-blue-300"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Sucessos -->
                    <div class="glassmorphism rounded-xl p-6 hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Sucessos</p>
                                <p class="text-3xl font-bold text-white mt-2" x-text="metrics.successful_jobs">0</p>
                                <p class="text-green-300 text-sm mt-1">
                                    Última execução<br>
                                    <span x-text="formatTime(metrics.last_execution?.timestamp)">--:--</span>
                                </p>
                            </div>
                            <div class="p-3 bg-green-500/20 rounded-lg">
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-300"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Falhas -->
                    <div class="glassmorphism rounded-xl p-6 hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Falhas</p>
                                <p class="text-3xl font-bold text-white mt-2" x-text="metrics.failed_jobs">0</p>
                                <p class="text-red-300 text-sm mt-1">
                                    Taxa de falha<br>
                                    <span x-text="(100 - metrics.success_rate) + '.0%'">0.0%</span>
                                </p>
                            </div>
                            <div class="p-3 bg-red-500/20 rounded-lg">
                                <i data-lucide="x-circle" class="w-6 h-6 text-red-300"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="glassmorphism rounded-xl p-6 hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total</p>
                                <p class="text-3xl font-bold text-white mt-2" x-text="metrics.total_jobs">0</p>
                                <button @click="triggerJob('weather_collection')" 
                                        class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-1">
                                    <i data-lucide="play" class="w-3 h-3"></i>
                                    <span>Executar Job</span>
                                </button>
                            </div>
                            <div class="p-3 bg-purple-500/20 rounded-lg">
                                <i data-lucide="activity" class="w-6 h-6 text-purple-300"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Temperature Chart -->
                    <div class="glassmorphism rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Temperatura - Campinas</h3>
                            <div class="flex items-center text-blue-200 text-sm">
                                <i data-lucide="thermometer" class="w-4 h-4 mr-1"></i>
                                Últimas 24h
                            </div>
                        </div>
                        <canvas id="temperatureChart" class="w-full h-64"></canvas>
                    </div>

                    <!-- Humidity Chart -->
                    <div class="glassmorphism rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Umidade</h3>
                            <div class="flex items-center text-blue-200 text-sm">
                                <i data-lucide="droplets" class="w-4 h-4 mr-1"></i>
                                Últimas 24h
                            </div>
                        </div>
                        <canvas id="humidityChart" class="w-full h-64"></canvas>
                    </div>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div x-show="activeTab === 'jobs'" x-transition class="space-y-6">
                <!-- DAG Visualization -->
                <div class="glassmorphism rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-white">Pipeline de Dados</h3>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-1 text-sm text-blue-200">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <span>Ativo</span>
                            </div>
                            <button @click="triggerJob('weather_collection')" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <i data-lucide="play" class="w-4 h-4"></i>
                                <span>Executar Agora</span>
                            </button>
                        </div>
                    </div>

                    <!-- DAG Flow -->
                    <div class="flex items-center justify-center space-x-8 py-8">
                        <!-- Start Node -->
                        <div class="dag-node dag-success text-center">
                            <i data-lucide="play-circle" class="w-8 h-8 mx-auto mb-2 text-green-600"></i>
                            <div class="font-medium text-gray-800">Iniciar</div>
                            <div class="text-xs text-gray-600">Trigger</div>
                        </div>

                        <!-- Arrow -->
                        <div class="flex items-center">
                            <div class="w-8 h-0.5 bg-gray-400"></div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 -ml-2"></i>
                        </div>

                        <!-- Collect Data Node -->
                        <div class="dag-node" :class="getJobStatus('weather_collection')">
                            <i data-lucide="cloud-download" class="w-8 h-8 mx-auto mb-2" :class="getJobStatusColor('weather_collection')"></i>
                            <div class="font-medium text-gray-800">Coletar Dados</div>
                            <div class="text-xs text-gray-600">weather_collection</div>
                        </div>

                        <!-- Arrow -->
                        <div class="flex items-center">
                            <div class="w-8 h-0.5 bg-gray-400"></div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 -ml-2"></i>
                        </div>

                        <!-- Store Data Node -->
                        <div class="dag-node dag-success">
                            <i data-lucide="database" class="w-8 h-8 mx-auto mb-2 text-green-600"></i>
                            <div class="font-medium text-gray-800">Armazenar</div>
                            <div class="text-xs text-gray-600">SQLite</div>
                        </div>

                        <!-- Arrow -->
                        <div class="flex items-center">
                            <div class="w-8 h-0.5 bg-gray-400"></div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 -ml-2"></i>
                        </div>

                        <!-- End Node -->
                        <div class="dag-node dag-success">
                            <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-green-600"></i>
                            <div class="font-medium text-gray-800">Concluído</div>
                            <div class="text-xs text-gray-600">Success</div>
                        </div>
                    </div>
                </div>

                <!-- Job Executions Table -->
                <div class="glassmorphism rounded-xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-white">Execuções Recentes</h3>
                        <div class="flex items-center text-blue-200 text-sm">
                            <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                            <span>Últimas 20 execuções</span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-left py-3 px-4 text-blue-100 font-medium">Job</th>
                                    <th class="text-left py-3 px-4 text-blue-100 font-medium">Status</th>
                                    <th class="text-left py-3 px-4 text-blue-100 font-medium">Duração</th>
                                    <th class="text-left py-3 px-4 text-blue-100 font-medium">Registros</th>
                                    <th class="text-left py-3 px-4 text-blue-100 font-medium">Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="job in jobs.executions" :key="job.id">
                                    <tr class="border-b border-white/10 hover:bg-white/5 transition-colors">
                                        <td class="py-3 px-4">
                                            <div class="flex items-center space-x-2">
                                                <i data-lucide="zap" class="w-4 h-4 text-blue-300"></i>
                                                <span class="text-white font-medium" x-text="job.job_name"></span>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium"
                                                  :class="getStatusClass(job.status)"
                                                  x-text="job.status"></span>
                                        </td>
                                        <td class="py-3 px-4 text-blue-100" x-text="formatDuration(job.duration_seconds)"></td>
                                        <td class="py-3 px-4 text-blue-100" x-text="job.records_processed || 0"></td>
                                        <td class="py-3 px-4 text-blue-100" x-text="formatTime(job.start_time)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                activeTab: 'analytics',
                metrics: {
                    jobs_today: 0,
                    successful_jobs: 0,
                    failed_jobs: 0,
                    total_jobs: 0,
                    success_rate: 0,
                    last_execution: null
                },
                weatherData: [],
                jobs: { executions: [] },
                temperatureChart: null,
                humidityChart: null,

                init() {
                    this.loadData();
                    this.initCharts();
                    // Auto-refresh a cada 30 segundos
                    setInterval(() => this.loadData(), 30000);
                },

                async loadData() {
                    try {
                        // Carregar métricas
                        const metricsResponse = await fetch('/api/metrics');
                        this.metrics = await metricsResponse.json();

                        // Carregar dados meteorológicos
                        const weatherResponse = await fetch('/api/weather');
                        this.weatherData = await weatherResponse.json();

                        // Carregar execuções de jobs
                        const jobsResponse = await fetch('/api/jobs');
                        this.jobs = await jobsResponse.json();

                        this.updateCharts();
                    } catch (error) {
                        console.error('Erro ao carregar dados:', error);
                    }
                },

                initCharts() {
                    // Temperature Chart
                    const tempCtx = document.getElementById('temperatureChart');
                    this.temperatureChart = new Chart(tempCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Temperatura (°C)',
                                data: [],
                                borderColor: '#60a5fa',
                                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { 
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: 'rgba(255,255,255,0.7)' }
                                },
                                x: { 
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: 'rgba(255,255,255,0.7)' }
                                }
                            }
                        }
                    });

                    // Humidity Chart
                    const humCtx = document.getElementById('humidityChart');
                    this.humidityChart = new Chart(humCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Umidade (%)',
                                data: [],
                                borderColor: '#34d399',
                                backgroundColor: 'rgba(52, 211, 153, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { 
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: 'rgba(255,255,255,0.7)' }
                                },
                                x: { 
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: 'rgba(255,255,255,0.7)' }
                                }
                            }
                        }
                    });
                },

                updateCharts() {
                    if (!this.weatherData.length) return;

                    const last24h = this.weatherData.slice(0, 24).reverse();
                    const labels = last24h.map(d => new Date(d.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));
                    const temperatures = last24h.map(d => d.temperature);
                    const humidity = last24h.map(d => d.humidity);

                    // Update temperature chart
                    this.temperatureChart.data.labels = labels;
                    this.temperatureChart.data.datasets[0].data = temperatures;
                    this.temperatureChart.update();

                    // Update humidity chart
                    this.humidityChart.data.labels = labels;
                    this.humidityChart.data.datasets[0].data = humidity;
                    this.humidityChart.update();
                },

                async triggerJob(jobName) {
                    try {
                        const response = await fetch(`/api/jobs/trigger/${jobName}`, { method: 'POST' });
                        if (response.ok) {
                            setTimeout(() => this.loadData(), 2000);
                        }
                    } catch (error) {
                        console.error('Erro ao executar job:', error);
                    }
                },

                refreshData() {
                    this.loadData();
                },

                formatTime(timestamp) {
                    if (!timestamp) return '--:--';
                    return new Date(timestamp).toLocaleString('pt-BR');
                },

                formatDuration(seconds) {
                    if (!seconds) return '0s';
                    return seconds < 1 ? `${Math.round(seconds * 1000)}ms` : `${seconds.toFixed(3)}s`;
                },

                getStatusClass(status) {
                    const classes = {
                        'success': 'status-success',
                        'error': 'status-error',
                        'running': 'status-running'
                    };
                    return classes[status] || 'bg-gray-500 text-white';
                },

                getJobStatus(jobName) {
                    const lastJob = this.jobs.executions.find(j => j.job_name === jobName);
                    if (!lastJob) return 'dag-node';
                    return `dag-${lastJob.status}`;
                },

                getJobStatusColor(jobName) {
                    const lastJob = this.jobs.executions.find(j => j.job_name === jobName);
                    if (!lastJob) return 'text-gray-600';
                    const colors = {
                        'success': 'text-green-600',
                        'error': 'text-red-600',
                        'running': 'text-yellow-600'
                    };
                    return colors[lastJob.status] || 'text-gray-600';
                }
            }
        }

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>

